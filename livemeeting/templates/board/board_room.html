{% extends "base.html" %}
{% block content %}
{% load static %}

<div id="main-board-container">
  <!-- å·¦ä¾§é¢æ¿ï¼šç”¨æˆ·åˆ—è¡¨å’Œå¯è¿›å…¥çš„å…¶ä»– Board -->
  <div id="left-panel">
    <h3>Board ç”¨æˆ·</h3>
    <div class="panel-section">
      <ul>
        {% for u in board.users.all %}
          <li>
            {% if u == board.created_by %}
              <strong>{{ u.username }} (Board ä¸»äºº)</strong>
            {% else %}
              <input type="radio" name="user_permission" value="{{ u.id }}" {% if u == authorized_user %}checked{% endif %}> 
              {{ u.username }} 
              {% if u == request.user %}
                <strong>(ä½ è‡ªå·±)</strong>
              {% endif %}
            {% endif %}
          </li>
        {% empty %}
          <li>No users yet</li>
        {% endfor %}
      </ul>
    </div>

    {% if is_host %}
      <p>ä½ æ˜¯è¿™ä¸ª Board çš„ä¸»äººï¼Œå¯ä»¥è¿›è¡Œç®¡ç†æ“ä½œã€‚</p>
      <!-- æˆæƒå’Œæ’¤é”€æŒ‰é’® -->
      <button id="grant-btn" onclick="grantPermission()">æˆæƒ</button>
      <button id="revoke-btn" onclick="revokePermission()">å–æ¶ˆæˆæƒ</button>
    {% else %}
      <p>ä½ ä¸æ˜¯è¿™ä¸ª Board çš„ä¸»äººã€‚</p>
    {% endif %}

    <h3>å¯è¿›å…¥çš„ Boards</h3>
    <div class="panel-section">
      <ul>
        {% for other_board in boards %}
          <li>
            <a href="{% url 'board_room_with_id' board_id=other_board.id %}">
              {{ other_board.name }}
              {% if other_board.id in boards_with_access %}
                (å·²åŠ å…¥)
              {% else %}
                (æœªåŠ å…¥)
              {% endif %}
            </a>
          </li>
        {% endfor %}
      </ul>
    </div>
  </div>

  <div id="permission-message"
       style="display:none; color:red; padding:5px; font-size:14px;"></div>

  <!-- å³ä¾§åŒºåŸŸï¼šBoard å’ŒèŠå¤©åŒºåŸŸ -->
  <div id="right-panel">
    <!-- ç™½æ¿åŒºåŸŸ -->
    <div id="board-area">
      <h2 id="board-title">Board: {{ board.name }}</h2>

      {% if user == board.created_by or user_has_permission %}

      <div id="toolbar">
          <!-- æ–°å¢ä¸¤æ’ï¼šç¬¬ä¸€æ’æ˜¯ share screen å’Œæ’­æ”¾è§†é¢‘ -->
          <div style="margin-bottom:8px;">
            <button id="btnShareScreen">âœï¸Share sharescreen</button>
            <button id="btnPlayVideo">âœï¸Play Video</button>
          </div>
          <!-- ç¬¬äºŒæ’åŸæ¥çš„å·¥å…·æŒ‰é’® -->
          <div>
            <button data-tool="pen">âœï¸ Pen</button>
            <button data-tool="eraser">ğŸ©¹ Eraser</button>
            <button data-tool="rect">â¬œ Rect</button>
            <button data-tool="circle">âšª Circle</button>
            <label>Color: <input type="color" id="color-picker" value="#000000"></label>
            <label>Width: <input type="number" id="line-width" value="2" min="1" max="20"></label>

            <button id="zoom-in-btn">ğŸ”+</button>
            <button id="zoom-out-btn">ğŸ”-</button>
            <button id="pan-btn">âœ‹ Pan</button>

            <button id="undo-btn">â†©ï¸ Undo</button>
            <button id="redo-btn">â†ªï¸ Redo</button>
            <button id="clear-btn">ğŸ—‘ï¸ Clear</button>
          </div>
        </div>
      {% else %}
        <p>ä½ åªèƒ½æŸ¥çœ‹ç™½æ¿ï¼Œæ— æ³•è¿›è¡Œæ“ä½œã€‚</p>
      {% endif %}

      <div id="canvas-wrap">
        <canvas id="board-canvas" width="1000" height="300"></canvas>
      </div>
    </div>

    <!-- èŠå¤©åŒºåŸŸ -->
    <div id="chat-area">
      <div id="chat-header">Chat</div>
      <div id="messages"></div>

      <div id="chat-input-container">
        <input id="chat-input" placeholder="Say something...">
        <button id="send-btn">Send</button>
      </div>
    </div>
  </div>
</div>

<!-- =================== â¬‡ Share Screen Modal =================== -->
<div id="sharescreenModal"
     style="display:none;
            position:fixed;
            left:0; top:0;
            width:100%; height:100%;
            background:rgba(0,0,0,0.55);
            z-index:9999;">
    
    <div style="background:white;
                width:900px;
                margin:60px auto;
                padding:15px;
                border-radius:6px;
                position:relative;">
        
        <span id="closeShare"
              style="position:absolute;right:15px;top:10px;
                     cursor:pointer;font-size:20px;">
            &times;
        </span>

        <h3>Share Screen</h3>

        <!-- iframe åŠ è½½ screen share é¡µé¢ -->
        <iframe id="shareFrame"
                style="width:100%;height:600px;border:none;"></iframe>

    </div>
</div>

<script>
  // âœ… BOARD_ID ç›´æ¥æ¸²æŸ“ä¸ºæ•°å­—
  const BOARD_ID = {{ board.id|default:"0" }};
  window.BOARD_ID = BOARD_ID;
  const isHost = "{{ is_host|yesno:'true,false' }}" === "true";

  function grantPermission() {
    const selectedUserId = document.querySelector('input[name="user_permission"]:checked')?.value;
    if (selectedUserId) {
      const url = "{% url 'grant_permission' board_id=board.id user_id='0' %}".replace('0', selectedUserId);
      window.location.href = url;
    } else {
      alert("è¯·é€‰æ‹©ä¸€ä¸ªç”¨æˆ·è¿›è¡Œæˆæƒï¼");
    }
  }

  function revokePermission() {
    const selectedUserId = document.querySelector('input[name="user_permission"]:checked')?.value;
    if (selectedUserId) {
      const url = "{% url 'revoke_permission' board_id=board.id user_id='0' %}".replace('0', selectedUserId);
      window.location.href = url;
    } else {
      alert("è¯·é€‰æ‹©ä¸€ä¸ªç”¨æˆ·è¿›è¡Œæ’¤é”€æˆæƒï¼");
    }
  }
</script>



<script src="/static/js/chat.js" defer></script>
<script src="/static/js/board.js" defer></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const shareBtn = document.getElementById("btnShareScreen");
    const closeBtn = document.getElementById("closeShare");

    if (shareBtn) {
        shareBtn.onclick = () => {
            const url = `${window.location.origin}/sharescreen/room/${BOARD_ID}/`;
            document.getElementById("shareFrame").src = url;
            document.getElementById("sharescreenModal").style.display = "block";
        };
    }

    if (closeBtn) {
        closeBtn.onclick = () => {
            document.getElementById("sharescreenModal").style.display = "none";
            document.getElementById("shareFrame").src = "";
        };
    }

    if (!shareBtn || !closeBtn) {
        console.warn("btnShareScreen æˆ– closeShare æœªæ‰¾åˆ°ï¼");
    }
});

</script>

{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{% static 'css/styles.css' %}">
{% endblock %}
