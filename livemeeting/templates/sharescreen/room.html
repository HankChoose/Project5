<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>桌面共享房间 {{ room_name }}</title>
</head>
<body>
<h1>房间: {{ room_name }}</h1>
<button id="start">开始共享桌面</button>
<div id="videos"></div>

<script>
const roomName = "{{ room_name }}";
const startButton = document.getElementById("start");
const videosContainer = document.getElementById("videos");

let localStream = null;
let userId = null;
let isHost = false;
const peers = {};

// 获取 host（局域网 IP 或 ngrok HTTPS host）
const urlParams = new URLSearchParams(window.location.search);
const host = urlParams.get('host') || window.location.hostname;

// WebSocket
const ws_scheme = window.location.protocol === "https:" ? "wss" : "ws";
const ws = new WebSocket(`${ws_scheme}://${host}:8000/ws/sharescreen/${roomName}/`);

ws.onopen = () => console.log("WebSocket connected");

ws.onmessage = async (event) => {
    const data = JSON.parse(event.data);

    if (data.type === "init") {
        userId = data.user_id;
        ws.send(JSON.stringify({ type: "join", user_id: userId }));
        return;
    }

    if (data.type === "new_user" && isHost) {
        const newUserId = data.new_user_id;
        const pc = createPeer(newUserId);
        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        ws.send(JSON.stringify({
            type: "offer",
            offer,
            sender_id: userId,
            target_id: newUserId
        }));
        return;
    }

    const sender = data.sender_id;
    if (!sender || sender === userId) return;

    if (data.type === "offer") {
        const pc = createPeer(sender);
        if (localStream) localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
        await pc.setRemoteDescription(data.offer);
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        ws.send(JSON.stringify({
            type: "answer",
            answer,
            sender_id: userId,
            target_id: sender
        }));
    }

    if (data.type === "answer") {
        if (peers[sender]) await peers[sender].setRemoteDescription(data.answer);
    }

    if (data.type === "candidate") {
        if (peers[sender]) await peers[sender].addIceCandidate(data.candidate);
    }
};

function createPeer(peerId) {
    if (peers[peerId]) return peers[peerId];

    const pc = new RTCPeerConnection({
        iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
    });

    pc.ontrack = (event) => {
        let video = document.getElementById(`video-${peerId}`);
        if (!video) {
            video = document.createElement("video");
            video.id = `video-${peerId}`;
            video.autoplay = true;
            video.style.width = "50%";
            video.style.border = "1px solid #000";
            videosContainer.appendChild(video);
        }
        video.srcObject = event.streams[0];
    };

    pc.onicecandidate = (e) => {
        if (e.candidate) {
            ws.send(JSON.stringify({
                type: "candidate",
                candidate: e.candidate,
                sender_id: userId,
                target_id: peerId
            }));
        }
    };

    peers[peerId] = pc;
    return pc;
}

// 点击共享桌面
startButton.onclick = async () => {
    try {
        localStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
    } catch(e) {
        alert("无法获取屏幕，请使用 HTTPS 或 localhost");
        console.error(e);
        return;
    }

    isHost = true;

    const localVideo = document.createElement("video");
    localVideo.autoplay = true;
    localVideo.muted = true;
    localVideo.srcObject = localStream;
    localVideo.style.width = "50%";
    localVideo.style.border = "1px solid #000";
    videosContainer.appendChild(localVideo);

    ws.send(JSON.stringify({ type: "start_share", user_id: userId }));
};
</script>
</body>
</html>
